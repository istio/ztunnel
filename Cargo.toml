[package]
name = "ztunnel"
version = "0.0.0"
edition = "2021"
rust-version = "1.77"

[features]
default = ["tls-ring"]
jemalloc = ["dep:tikv-jemallocator", "dep:jemalloc_pprof"]
tls-boring = ["dep:boring", "dep:boring-sys", "boring-rustls-provider/fips-only"]
tls-ring = ["dep:ring", "rustls/ring", "tokio-rustls/ring", "hyper-rustls/ring", "dep:rcgen"]
testing = ["dep:rcgen", "rcgen/x509-parser"] # Enables utilities supporting tests.

[lib]
path = "src/lib.rs"
bench = false

[[bin]]
name = "ztunnel"
path = "src/main.rs"
bench = false

[[bench]]
name = "throughput"
harness = false

[dependencies]
# Enabled with 'tls-boring'
boring-rustls-provider = { git = "https://github.com/janrueth/boring-rustls-provider", optional = true } #
boring = { version = "4", optional = true }
boring-sys = { version = "4", optional = true }

# Enabled with 'tls-ring'
ring = { version = "0.17", optional = true }

anyhow = "1.0"
async-stream = "0.3"
async-trait = "0.1"
base64 = "0.22"
byteorder = "1.5"
bytes = { version = "1.5", features = ["serde"] }
chrono = "0.4"
duration-str = "0.7"
futures = "0.3"
futures-core = "0.3"
futures-util = "0.3"
jemalloc_pprof = { version = "0.1.0", optional = true }
tikv-jemallocator = { version = "0.5.4", features = ["profiling", "unprefixed_malloc_on_supported_platforms"], optional = true }
hashbrown = "0.14"
hickory-client = "0.24"
hickory-proto = "0.24"
hickory-resolver = "0.24"
hickory-server = { version = "0.24", features = [ "hickory-resolver" ] }
http-body = { package = "http-body", version = "1" }
http-body-util = "0.1"
http-types = { version = "2.12", default-features = false }
hyper = { version = "1.3", features = ["full"] }
hyper-rustls = { version = "0.27.0", default-features = false, features = ["logging", "http1", "http2"] }
hyper-util = { version = "0.1", features = ["full"] }
ipnet = { version = "2.9", features = ["serde"] }
itertools = "0.12"
keyed_priority_queue = "0.4"
libc = "0.2"
log = "0.4"
nix = { version = "0.28", features = ["socket", "sched", "uio", "fs", "ioctl", "user", "net", "mount"] }
once_cell = "1.19"
ppp = "2.2"
prometheus-client = { version = "0.22" }
prometheus-parse = "0.2"
prost = "0.13"
prost-types = "0.13"
rand = "0.8"
rcgen = { version = "0.13", optional = true, features = ["pem"] }
rustls = { version = "0.23", default-features = false }
rustls-native-certs = "0.7.0"
rustls-pemfile = "2.1"
serde = { version = "1.0", features = ["derive", "rc"] }
serde_json = "1.0"
serde_yaml = "0.9"
socket2 = { git = "https://github.com/keithmattix/socket2.git", branch="windows-original-dst", features = ["all"] }
textnonce = { version = "1.0" }
thiserror = "1.0"
tls-listener = { version = "0.10" }
tokio = { version = "1.0", features = ["full", "test-util"] }
tokio-rustls = { version = "0.26", default-features = false }
tokio-stream = { version = "0.1", features = ["net"] }
tonic = { version = "0.12", default-features = false, features = ["prost", "codegen"] }
tower = { version = "0.4", features = ["full"] }
tracing = { version = "0.1"}
tracing-subscriber = { version = "0.3", features = ["registry", "env-filter", "json"] }
url = "2.2"
x509-parser = { version = "0.16", default-features = false }
tracing-log = "0.2"
backoff = "0.4.0"
pin-project-lite = "0.2"
pingora-pool = "0.1.0"
flurry = "0.5.0"
h2 = "0.4.5"
http = "1.1"
split-iter = "0.1"
arcstr = { version = "1.1", features = ["serde"] }
tracing-core = "0.1.32"
tracing-appender = "0.2.3"
tokio-util = { version = "0.7.11", features = ["io-util"] }

[target.'cfg(target_os = "linux")'.dependencies]
netns-rs = "0.1"

[target.'cfg(not(target_os = "windows"))'.dependencies]
pprof = { version = "0.13", features = ["protobuf", "protobuf-codec", "criterion"] }

[target.'cfg(target_os = "windows")'.dependencies]
windows = { version = "0.58.0", features = ["Win32_System_HostCompute", "Win32_System_HostComputeNetwork", "Win32_System_HostComputeSystem", "Win32_NetworkManagement_IpHelper"] }
hcn = { git = "https://github.com/jsturtevant/hcn-rs.git" }

[build-dependencies]
tonic-build = { version = "0.12", default-features = false, features = ["prost"] }
prost-build = "0.13"
anyhow = "1.0"
rustc_version = "0.4"
cfg-if = "1.0"

[profile.release]
opt-level = 3
codegen-units = 1
lto = true

[profile.bench]
inherits = "quick-release"

[profile.symbols-release]
inherits = "release"
debug = true

# Release optimized but without as many dependencies, suitable for incremental development
[profile.quick-release]
inherits = "release"
codegen-units = 16
lto = false
incremental = true

[dev-dependencies]
# Enable testing utils on this crate.
ztunnel = { version = "0.0.0", path = ".", default-features = false, features = ["testing"] }

criterion = { version = "0.5", features = ["async_tokio", "html_reports"] }
diff = "0.1"
local-ip-address = "0.6"
matches = "0.1"
test-case = "3.3"
oid-registry = "0.7"
rcgen = { version = "0.13", features = ["pem", "x509-parser"] }
ctor = "0.2"

[lints.clippy]
# This rule makes code more confusing
assigning_clones = "allow"
# This doesn't understand `strng` which we use everywhere
borrow_interior_mutable_const = "allow"
declare_interior_mutable_const = "allow"
